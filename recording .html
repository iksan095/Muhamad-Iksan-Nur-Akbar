u<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Recording - Rekam Audio</title>
  <style>
    :root{ --bg:#0f172a; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; color-scheme: dark; }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial; margin:0; min-height:100vh; background:linear-gradient(180deg,#071129 0%, #071a2a 100%); color:#e6eef8; display:flex; align-items:center; justify-content:center; padding:24px}
    .card{width:100%; max-width:880px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:20px; box-shadow:0 8px 30px rgba(2,6,23,.6);}
    h1{margin:0 0 8px 0; font-size:20px}
    p.lead{margin:0 0 18px 0; color:var(--muted)}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    button{background:#081221;border:1px solid rgba(255,255,255,0.04); color:var(--accent); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
    button.secondary{background:transparent; color:#cfeff6; border:1px solid rgba(255,255,255,0.06)}
    button.danger{background:#9b1c1c; color:#fff}
    .status{margin-left:8px; color:#7ee7f2; font-weight:600}
    .meter{height:8px; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; margin-top:14px}
    .meter > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#06b6d4,#7c3aed);}
    .list{margin-top:18px}
    .item{display:flex; align-items:center; gap:12px; padding:10px; border-radius:8px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02);}
    .item audio{width:220px}
    .meta{flex:1}
    .small{font-size:13px; color:var(--muted)}
    @media (max-width:600px){ .item audio{width:140px} }
  </style>
</head>
<body>
  <div class="card">
    <h1>Aplikasi Recording — Rekam Audio di Browser</h1>
    <p class="lead">Rekam audio menggunakan microphone, mainkan kembali, dan unduh file hasil rekaman. Bekerja di Chrome/Edge/Firefox modern dan di sebagian besar browser mobile yang mendukung <code>MediaRecorder</code>.</p>

    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="pauseBtn" class="secondary" disabled>Pause</button>
      <button id="resumeBtn" class="secondary" disabled>Resume</button>
      <button id="stopBtn" class="danger" disabled>Stop</button>
      <div class="status" id="status">Idle</div>
    </div>

    <div class="meter" aria-hidden="true"><i id="meterFill"></i></div>

    <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
      <label class="small">Format:</label>
      <select id="mimeSelect">
        <option value="audio/webm">audio/webm (recommended)</option>
        <option value="audio/ogg">audio/ogg</option>
        <option value="audio/wav">audio/wav (constructed)</option>
      </select>
      <div style="flex:1"></div>
      <button id="clearBtn" class="secondary">Hapus Semua</button>
    </div>

    <div class="list" id="recordings"></div>

    <p class="small" style="margin-top:12px">Catatan: Jika browser tidak mendukung perekaman, Anda akan melihat pesan kesalahan. Untuk hasil terbaik gunakan Chrome atau Edge, dan pastikan situs diakses via HTTPS (atau localhost).</p>
  </div>

<script>
(async function(){
  const startBtn = document.getElementById('startBtn')
  const pauseBtn = document.getElementById('pauseBtn')
  const resumeBtn = document.getElementById('resumeBtn')
  const stopBtn = document.getElementById('stopBtn')
  const statusEl = document.getElementById('status')
  const recordingsEl = document.getElementById('recordings')
  const meterFill = document.getElementById('meterFill')
  const mimeSelect = document.getElementById('mimeSelect')
  const clearBtn = document.getElementById('clearBtn')

  let mediaStream = null
  let mediaRecorder = null
  let chunks = []
  let audioContext = null
  let analyser = null
  let sourceNode = null

  function setStatus(s){ statusEl.textContent = s }

  function updateButtons(state){
    // states: idle, recording, paused
    if(state === 'idle'){
      startBtn.disabled = false
      pauseBtn.disabled = true
      resumeBtn.disabled = true
      stopBtn.disabled = true
    }else if(state === 'recording'){
      startBtn.disabled = true
      pauseBtn.disabled = false
      resumeBtn.disabled = true
      stopBtn.disabled = false
    }else if(state === 'paused'){
      startBtn.disabled = true
      pauseBtn.disabled = true
      resumeBtn.disabled = false
      stopBtn.disabled = false
    }
  }

  function createRecordingItem(blob, mimeType){
    const url = URL.createObjectURL(blob)
    const item = document.createElement('div')
    item.className = 'item'

    const meta = document.createElement('div')
    meta.className = 'meta'
    const title = document.createElement('div')
    title.textContent = `Rekaman — ${new Date().toLocaleString()}`
    const sub = document.createElement('div')
    sub.className = 'small'
    sub.textContent = `${(blob.size/1024).toFixed(1)} KB — ${mimeType}`
    meta.appendChild(title)
    meta.appendChild(sub)

    const audio = document.createElement('audio')
    audio.controls = true
    audio.src = url

    const downloadBtn = document.createElement('button')
    downloadBtn.textContent = 'Unduh'
    downloadBtn.onclick = () => {
      const a = document.createElement('a')
      a.href = url
      const ext = mimeType.includes('ogg') ? 'ogg' : mimeType.includes('webm') ? 'webm' : 'wav'
      a.download = `rekaman-${Date.now()}.${ext}`
      a.click()
    }

    const delBtn = document.createElement('button')
    delBtn.textContent = 'Hapus'
    delBtn.className = 'secondary'
    delBtn.onclick = () => { URL.revokeObjectURL(url); recordingsEl.removeChild(item) }

    const actions = document.createElement('div')
    actions.style.display = 'flex'
    actions.style.gap = '8px'
    actions.appendChild(downloadBtn)
    actions.appendChild(delBtn)

    item.appendChild(meta)
    item.appendChild(audio)
    item.appendChild(actions)

    recordingsEl.prepend(item)
  }

  function stopAnalyser(){
    if(audioContext){
      try{ audioContext.close() }catch(e){}
      audioContext = null
      analyser = null
      sourceNode = null
    }
    meterFill.style.width = '0%'
  }

  function startAnalyser(stream){
    try{
      audioContext = new (window.AudioContext || window.webkitAudioContext)()
      analyser = audioContext.createAnalyser()
      sourceNode = audioContext.createMediaStreamSource(stream)
      sourceNode.connect(analyser)
      analyser.fftSize = 256

      const data = new Uint8Array(analyser.frequencyBinCount)
      function frame(){
        if(!analyser) return
        analyser.getByteFrequencyData(data)
        let sum = 0
        for(let i=0;i<data.length;i++) sum += data[i]
        const avg = sum / data.length
        const pct = Math.min(100, Math.max(0, (avg / 255) * 100))
        meterFill.style.width = pct + '%'
        requestAnimationFrame(frame)
      }
      requestAnimationFrame(frame)
    }catch(e){ console.warn('Analyser not available', e); stopAnalyser() }
  }

  async function startRecording(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      alert('getUserMedia tidak didukung di browser ini.')
      return
    }

    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true })
      startAnalyser(mediaStream)

      const selectedMime = mimeSelect.value
      let options = {}

      if(MediaRecorder.isTypeSupported(selectedMime)){
        options.mimeType = selectedMime
      } else {
        // fallback: let browser pick
        options = {}
      }

      chunks = []
      mediaRecorder = new MediaRecorder(mediaStream, options)

      mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) chunks.push(e.data) }

      mediaRecorder.onstart = () => { setStatus('Recording'); updateButtons('recording') }
      mediaRecorder.onpause = () => { setStatus('Paused'); updateButtons('paused') }
      mediaRecorder.onresume = () => { setStatus('Recording'); updateButtons('recording') }
      mediaRecorder.onstop = () => {
        setStatus('Idle')
        updateButtons('idle')
        stopAnalyser()
        // assemble blob
        const blob = new Blob(chunks, { type: mediaRecorder.mimeType || 'audio/webm' })
        createRecordingItem(blob, blob.type)
        // cleanup
        if(mediaStream){
          mediaStream.getTracks().forEach(t=>t.stop())
          mediaStream = null
        }
        mediaRecorder = null
      }

      mediaRecorder.start()
    }catch(err){
      console.error(err)
      alert('Gagal mengakses microphone: ' + (err.message || err))
    }
  }

  function pauseRecording(){ if(mediaRecorder && mediaRecorder.state === 'recording'){ mediaRecorder.pause() } }
  function resumeRecording(){ if(mediaRecorder && mediaRecorder.state === 'paused'){ mediaRecorder.resume() } }
  function stopRecording(){ if(mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')){ mediaRecorder.stop() } }

  startBtn.addEventListener('click', ()=>{ startRecording() })
  pauseBtn.addEventListener('click', ()=>{ pauseRecording() })
  resumeBtn.addEventListener('click', ()=>{ resumeRecording() })
  stopBtn.addEventListener('click', ()=>{ stopRecording() })

  clearBtn.addEventListener('click', ()=>{ recordingsEl.innerHTML = '' })

  // initialize
  updateButtons('idle')

  // graceful feature detection message
  if(!('MediaRecorder' in window)){
    setStatus('MediaRecorder tidak tersedia di browser ini')
    startBtn.disabled = true
    alert('Peringatan: Browser Anda mungkin tidak mendukung MediaRecorder. Gunakan Chrome/Edge/Firefox terbaru.')
  }

})();
</script>
</body>
</html>